INICIO

    // --- 1. Configuración inicial de la API ---
    CARGAR VariablesEntorno()
    OBTENER API_KEY DE VariablesEntorno
    
    SI API_KEY ES NULO ENTONCES
        LANZAR Error("Clave de API no encontrada")
    FIN SI
    
    INICIALIZAR ClienteAPI CON API_KEY

    // --- 2. Cargar datos de coordenadas ---
    CARGAR Diccionario_Ubicaciones_Principales DESDE archivo_coordenadas_principales
    CARGAR Diccionario_Servicios_Tipo1 DESDE archivo_coordenadas_tipo1
    CARGAR Diccionario_Servicios_Tipo2 DESDE archivo_coordenadas_tipo2
    CARGAR Diccionario_Servicios_TipoN DESDE archivo_coordenadas_tipoN
    CARGAR Diccionario_Referencias DESDE archivo_coordenadas_referencias

    // --- 3. Cargar tabla de relaciones ---
    LEER DataFrame_Relaciones DESDE archivo_relaciones_servicios
    
    // Convertir strings de listas a listas reales
    PARA CADA columna_lista EN DataFrame_Relaciones HACER
        DataFrame_Relaciones[columna_lista] ← CONVERTIR_STRING_A_LISTA(DataFrame_Relaciones[columna_lista])
    FIN PARA

    // --- 4. Definir función de consulta a API ---
    FUNCIÓN ObtenerDistancia(origen, destinos, modo_transporte)
        // Extraer datos del origen
        (origen_id, origen_coordenadas) ← origen
        destinos_coordenadas ← EXTRAER_COORDENADAS(destinos)
        
        // Configurar parámetros según modo de transporte
        SI modo_transporte = "transporte_publico" ENTONCES
            hora_salida ← DEFINIR_HORA_PICO()  // ej: miércoles 8:30 AM
            respuesta_api ← LLAMAR_API_MATRIZ_DISTANCIAS(
                origen: origen_coordenadas,
                destinos: destinos_coordenadas,
                modo: modo_transporte,
                hora_salida: hora_salida
            )
        SINO
            respuesta_api ← LLAMAR_API_MATRIZ_DISTANCIAS(
                origen: origen_coordenadas,
                destinos: destinos_coordenadas,
                modo: modo_transporte
            )
        FIN SI
        
        // Guardar respuesta completa para auditoría
        GUARDAR respuesta_api EN archivo_respuesta(origen_id + "_" + modo_transporte)
        
        // Procesar resultados
        CREAR Lista_Resultados ← VACÍA
        
        PARA i = 0 HASTA LONGITUD(destinos) HACER
            (destino_id, _) ← destinos[i]
            elemento_respuesta ← respuesta_api.elementos[i]
            
            SI elemento_respuesta.estado ≠ "OK" ENTONCES
                IMPRIMIR "Error calculando distancia: " + origen_id + " → " + destino_id + " (" + elemento_respuesta.estado + ")"
                CONTINUAR
            FIN SI
            
            distancia ← elemento_respuesta.distancia.valor SI EXISTE
            duracion ← elemento_respuesta.duracion.valor SI EXISTE
            
            AÑADIR A Lista_Resultados: {
                "origen": origen_id,
                "destino": destino_id,
                "distancia_metros": distancia,
                "duracion_segundos": duracion,
                "modo_transporte": modo_transporte
            }
        FIN PARA
        
        DEVOLVER Lista_Resultados
    FIN FUNCIÓN

    // --- 5. Procesar todas las combinaciones ---
    CREAR Lista_Resultados_Total ← VACÍA
    INICIALIZAR contador_peticiones ← 0
    
    PARA CADA fila EN DataFrame_Relaciones HACER
        id_region ← fila.id_region
        
        // Buscar ubicaciones principales en esta región
        PARA CADA ubicacion_id EN Diccionario_Ubicaciones_Principales HACER
            ubicacion ← Diccionario_Ubicaciones_Principales[ubicacion_id]
            
            SI ubicacion.region ≠ id_region ENTONCES
                CONTINUAR
            FIN SI
            
            // Preparar origen
            origen ← [ubicacion_id, ubicacion.coordenadas]
            
            // Preparar destinos combinando todos los servicios asignados
            CREAR Lista_Destinos ← VACÍA
            
            PARA CADA tipo_servicio EN tipos_servicios HACER
                diccionario_servicio ← OBTENER_DICCIONARIO_POR_TIPO(tipo_servicio)
                
                PARA CADA servicio_id EN fila[tipo_servicio] HACER
                    SI servicio_id EXISTE EN diccionario_servicio ENTONCES
                        AÑADIR A Lista_Destinos: (servicio_id, diccionario_servicio[servicio_id])
                    FIN SI
                FIN PARA
            FIN PARA
            
            // Añadir referencias asociadas a la ubicación
            PARA CADA referencia_id EN ubicacion.referencias_asociadas HACER
                AÑADIR A Lista_Destinos: (referencia_id, Diccionario_Referencias[referencia_id])
            FIN PARA
            
            // Realizar consultas para diferentes modos de transporte
            PARA CADA modo EN ["vehiculo_privado", "transporte_publico"] HACER
                resultados_modo ← ObtenerDistancia(origen, Lista_Destinos, modo)
                AÑADIR resultados_modo A Lista_Resultados_Total
                INCREMENTAR contador_peticiones
            FIN PARA
        FIN PARA
    FIN PARA
    
    IMPRIMIR "Total de peticiones enviadas a la API: " + contador_peticiones

    // --- 6. Procesar y exportar resultados ---
    // Aplanar estructura de resultados anidados
    CREAR Lista_Resultados_Planos ← VACÍA
    PARA CADA sublista EN Lista_Resultados_Total HACER
        PARA CADA resultado EN sublista HACER
            AÑADIR resultado A Lista_Resultados_Planos
        FIN PARA
    FIN PARA
    
    // Convertir a formato tabular
    DataFrame_Resultados ← CONVERTIR_A_DATAFRAME(Lista_Resultados_Planos)
    
    // Exportar resultados
    GUARDAR DataFrame_Resultados EN "resultados_distancias_API.csv"
    

FIN

// --- ESTRUCTURA DE DATOS DE SALIDA ---

resultados_distancias_API.csv:
{
    origen,destino,distancia_metros,duracion_segundos,modo_transporte
    ubicacion_001,servicio_A01,15420,1235,vehiculo_privado
    ubicacion_001,servicio_A01,18650,2890,transporte_publico
    ubicacion_001,referencia_X01,8750,945,vehiculo_privado
    ubicacion_001,referencia_X01,12340,1820,transporte_publico
    ...
}

// --- ARCHIVOS AUXILIARES GENERADOS ---
// Para cada consulta se genera un archivo JSON con la respuesta completa de la API:
// - ubicacion_001_vehiculo_privado.json
// - ubicacion_001_transporte_publico.json
// - ubicacion_002_vehiculo_privado.json
// - ...