INICIO

    // --- 1. Cargar y preparar datos geoespaciales principales ---
    LEER GeoDataFrame DatosUbicaciones (ID_ubicacion, Nombre_ubicacion, ID_region, Geometría)
    LEER DataFrame CriteriosFiltrado (ID_region, Atributo_filtro)
    
    // Aplicar criterios de filtrado
    UNIR DatosUbicaciones CON CriteriosFiltrado POR ID_region
    FILTRAR DatosUbicaciones SEGÚN Atributo_filtro
    
    // Normalizar geometría y sistema de coordenadas
    PARA CADA ubicacion EN DatosUbicaciones HACER
        SI ubicacion.Geometría ES Polígono ENTONCES
            ubicacion.Punto ← CALCULAR_CENTROIDE(ubicacion.Geometría)
        SINO
            ubicacion.Punto ← ubicacion.Geometría
        FIN SI
        
        (ubicacion.Longitud, ubicacion.Latitud) ← CONVERTIR_A_COORDENADAS_GEOGRAFICAS(ubicacion.Punto)
        ubicacion.ID_normalizado ← NORMALIZAR_IDENTIFICADOR(ubicacion.ID_ubicacion)
    FIN PARA

    // --- 2. Procesar datos de referencia ---
    LEER GeoDataFrame DatosReferencia (ID_referencia, Nombre_referencia, Geometría)
    APLICAR FiltrosCategoricos A DatosReferencia
    
    PARA CADA referencia EN DatosReferencia HACER
        SI referencia.Geometría ES Polígono ENTONCES
            referencia.Punto ← CALCULAR_CENTROIDE(referencia.Geometría)
        SINO
            referencia.Punto ← referencia.Geometría
        FIN SI
        
        referencia.ID_normalizado ← NORMALIZAR_IDENTIFICADOR(referencia.Nombre_referencia)
        (referencia.Longitud, referencia.Latitud) ← CONVERTIR_A_COORDENADAS_GEOGRAFICAS(referencia.Punto)
    FIN PARA

    // --- 3. Establecer relaciones espaciales ---
    CREAR Matriz_Relaciones ← VACÍA
    
    PARA CADA ubicacion EN DatosUbicaciones HACER
        CREAR Lista_Distancias ← VACÍA
        
        PARA CADA referencia EN DatosReferencia HACER
            distancia ← CALCULAR_DISTANCIA(ubicacion.Punto, referencia.Punto)
            AÑADIR (referencia.ID_normalizado, distancia) A Lista_Distancias
        FIN PARA
        
        // Seleccionar N elementos más cercanos
        ORDENAR Lista_Distancias POR distancia ASCENDENTE
        referencias_cercanas ← PRIMEROS_N(Lista_Distancias, N)
        
        Matriz_Relaciones[ubicacion.ID_normalizado] ← referencias_cercanas
    FIN PARA

    // --- 4. Crear estructura de datos principal ---
    CREAR Diccionario_Principal ← VACÍO
    
    PARA CADA ubicacion EN DatosUbicaciones HACER
        Diccionario_Principal[ubicacion.ID_normalizado] ← {
            "coordenadas": (ubicacion.Latitud, ubicacion.Longitud),
            "region": ubicacion.ID_normalizado,
            "referencias_asociadas": Matriz_Relaciones[ubicacion.ID_normalizado]
        }
    FIN PARA

    // --- 5. Procesar datasets de servicios auxiliares ---
    PARA CADA tipo_servicio EN TiposServicios HACER
        LEER GeoDataFrame Servicios (ID_servicio, Geometría)
        
        // Si existe tabla de correspondencias de nombres
        SI EXISTE TablaCorrespondencias ENTONCES
            LEER DataFrame TablaCorrespondencias (Nombre_servicio, ID_servicio)
            NORMALIZAR nombres EN AMBAS tablas
            UNIR Servicios CON TablaCorrespondencias POR nombre_normalizado
        FIN SI
        
        // Convertir a coordenadas geográficas
        CONVERTIR Servicios A SISTEMA_COORDENADAS_OBJETIVO
        
        // Crear diccionario de coordenadas
        CREAR Diccionario_Servicio ← VACÍO
        PARA CADA servicio EN Servicios HACER
            Diccionario_Servicio[servicio.ID_servicio] ← (servicio.Latitud, servicio.Longitud)
        FIN PARA
        
        GUARDAR Diccionario_Servicio EN "coordenadas_" + tipo_servicio + ".json"
    FIN PARA

    // --- 6. Crear estructura de datos de referencia ---
    CREAR Diccionario_Referencias ← VACÍO
    
    PARA CADA referencia EN DatosReferencia HACER
        Diccionario_Referencias[referencia.ID_normalizado] ← (referencia.Latitud, referencia.Longitud)
    FIN PARA
    
    GUARDAR Diccionario_Referencias EN "coordenadas_referencias.json"

    // --- 7. Exportar resultado principal ---
    GUARDAR Diccionario_Principal EN "datos_principales.json"

    // --- 8. Devolver conjunto de archivos generados ---
    DEVOLVER Lista_Archivos_JSON_Generados

FIN

// --- ESTRUCTURA GENÉRICA DE ARCHIVOS JSON ---

datos_principales.json:
{
   "ubicacion_id1": {
       "coordenadas": (latitud, longitud),
       "region": "region_id",
       "referencias_asociadas": ["ref1_id", "ref2_id", "ref3_id"]
   },
   "ubicacion_id2": { ... },
   ...
}

coordenadas_servicio_tipo.json:
{
   "servicio_id1": (latitud, longitud),
   "servicio_id2": (latitud, longitud),
   ...
}

coordenadas_referencias.json:
{
   "referencia_id1": (latitud, longitud),
   "referencia_id2": (latitud, longitud),
   ...
}